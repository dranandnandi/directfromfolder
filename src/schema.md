-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.attendance (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  organization_id uuid,
  date date NOT NULL,
  shift_id uuid,
  punch_in_time timestamp with time zone,
  punch_in_latitude numeric,
  punch_in_longitude numeric,
  punch_in_address text,
  punch_in_selfie_url text,
  punch_in_device_info jsonb,
  punch_out_time timestamp with time zone,
  punch_out_latitude numeric,
  punch_out_longitude numeric,
  punch_out_address text,
  punch_out_selfie_url text,
  punch_out_device_info jsonb,
  total_hours numeric,
  break_hours numeric DEFAULT 1.0 CHECK (break_hours >= 0::numeric),
  effective_hours numeric,
  is_late boolean DEFAULT false,
  is_early_out boolean DEFAULT false,
  is_absent boolean DEFAULT false,
  is_holiday boolean DEFAULT false,
  is_weekend boolean DEFAULT false,
  is_regularized boolean DEFAULT false,
  regularized_by uuid,
  regularization_reason text,
  regularized_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  punch_in_distance_meters numeric,
  punch_out_distance_meters numeric,
  is_outside_geofence boolean DEFAULT false,
  geofence_override_by uuid,
  geofence_override_reason text,
  geofence_override_at timestamp with time zone,
  is_early_leave boolean DEFAULT false,
  ai_hydration_meta jsonb,
  ai_hydrated_at timestamp with time zone,
  ai_source USER-DEFINED NOT NULL DEFAULT 'default'::ai_source_enum,
  CONSTRAINT attendance_pkey PRIMARY KEY (id),
  CONSTRAINT attendance_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT attendance_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT attendance_shift_id_fkey FOREIGN KEY (shift_id) REFERENCES public.shifts(id),
  CONSTRAINT attendance_regularized_by_fkey FOREIGN KEY (regularized_by) REFERENCES public.users(id),
  CONSTRAINT attendance_geofence_override_by_fkey FOREIGN KEY (geofence_override_by) REFERENCES public.users(id)
);
CREATE TABLE public.attendance_ai_decisions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  run_id uuid NOT NULL,
  user_id uuid,
  attendance_id uuid,
  decision_type text NOT NULL CHECK (decision_type = ANY (ARRAY['late_flag'::text, 'holiday_flag'::text, 'override_apply'::text, 'ot_calc'::text, 'attendance_status'::text])),
  decision_payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  source_priority USER-DEFINED NOT NULL DEFAULT 'ai'::ai_source_priority_enum,
  confidence numeric,
  human_review_required boolean NOT NULL DEFAULT false,
  reviewed_by uuid,
  reviewed_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT attendance_ai_decisions_pkey PRIMARY KEY (id),
  CONSTRAINT attendance_ai_decisions_run_id_fkey FOREIGN KEY (run_id) REFERENCES public.attendance_ai_runs(id),
  CONSTRAINT attendance_ai_decisions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT attendance_ai_decisions_attendance_id_fkey FOREIGN KEY (attendance_id) REFERENCES public.attendance(id),
  CONSTRAINT attendance_ai_decisions_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.users(id)
);
CREATE TABLE public.attendance_ai_policies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  policy_name text NOT NULL,
  policy_version integer NOT NULL DEFAULT 1,
  status USER-DEFINED NOT NULL DEFAULT 'draft'::ai_policy_status_enum,
  instruction_text text NOT NULL,
  instruction_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  model_name text NOT NULL DEFAULT 'gemini-2.5-flash'::text,
  confidence_score numeric,
  created_by uuid,
  approved_by uuid,
  approved_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT attendance_ai_policies_pkey PRIMARY KEY (id),
  CONSTRAINT attendance_ai_policies_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT attendance_ai_policies_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT attendance_ai_policies_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id)
);
CREATE TABLE public.attendance_ai_runs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  policy_id uuid,
  run_type text NOT NULL CHECK (run_type = ANY (ARRAY['weekly_hydration'::text, 'shift_compile'::text, 'payroll_preview'::text])),
  period_start date,
  period_end date,
  input_snapshot jsonb NOT NULL DEFAULT '{}'::jsonb,
  output_summary jsonb NOT NULL DEFAULT '{}'::jsonb,
  status USER-DEFINED NOT NULL DEFAULT 'running'::ai_run_status_enum,
  error_message text,
  started_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT attendance_ai_runs_pkey PRIMARY KEY (id),
  CONSTRAINT attendance_ai_runs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT attendance_ai_runs_policy_id_fkey FOREIGN KEY (policy_id) REFERENCES public.attendance_ai_policies(id)
);
CREATE TABLE public.attendance_import_batches (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  month integer NOT NULL CHECK (month >= 1 AND month <= 12),
  year integer NOT NULL,
  source text NOT NULL CHECK (source = ANY (ARRAY['excel'::text, 'csv'::text, 'biometric'::text])),
  file_url text,
  detected_format jsonb,
  column_mapping jsonb,
  status text NOT NULL DEFAULT 'uploaded'::text CHECK (status = ANY (ARRAY['uploaded'::text, 'mapped'::text, 'validated'::text, 'applied'::text, 'rejected'::text])),
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT attendance_import_batches_pkey PRIMARY KEY (id),
  CONSTRAINT attendance_import_batches_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT attendance_import_batches_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.attendance_import_rows (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  batch_id uuid NOT NULL,
  raw jsonb NOT NULL,
  normalized jsonb,
  match_confidence numeric,
  user_id uuid,
  validation_errors jsonb,
  is_duplicate boolean DEFAULT false,
  will_apply boolean DEFAULT true,
  decision text,
  notes text,
  CONSTRAINT attendance_import_rows_pkey PRIMARY KEY (id),
  CONSTRAINT attendance_import_rows_batch_id_fkey FOREIGN KEY (batch_id) REFERENCES public.attendance_import_batches(id),
  CONSTRAINT attendance_import_rows_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.attendance_monthly_overrides (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid NOT NULL,
  month integer NOT NULL CHECK (month >= 1 AND month <= 12),
  year integer NOT NULL,
  source_batch_id uuid,
  payload jsonb NOT NULL,
  approved_by uuid,
  approved_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  source text NOT NULL DEFAULT ('manual'::text)::manual_ai_source,
  CONSTRAINT attendance_monthly_overrides_pkey PRIMARY KEY (id),
  CONSTRAINT attendance_monthly_overrides_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT attendance_monthly_overrides_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT attendance_monthly_overrides_source_batch_id_fkey FOREIGN KEY (source_batch_id) REFERENCES public.attendance_import_batches(id),
  CONSTRAINT attendance_monthly_overrides_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id)
);
CREATE TABLE public.attendance_regularizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  attendance_id uuid,
  requested_by uuid,
  approved_by uuid,
  reason text NOT NULL,
  admin_remarks text,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'approved'::character varying, 'rejected'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT attendance_regularizations_pkey PRIMARY KEY (id),
  CONSTRAINT attendance_regularizations_attendance_id_fkey FOREIGN KEY (attendance_id) REFERENCES public.attendance(id),
  CONSTRAINT attendance_regularizations_requested_by_fkey FOREIGN KEY (requested_by) REFERENCES public.users(id),
  CONSTRAINT attendance_regularizations_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id)
);
CREATE TABLE public.compliance_rules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  country text NOT NULL DEFAULT 'IN'::text,
  state text NOT NULL,
  rule_type text NOT NULL CHECK (rule_type = ANY (ARRAY['PF'::text, 'ESIC'::text, 'PT'::text, 'TDS'::text, 'BONUS'::text, 'GRATUITY'::text, 'MIN_WAGE'::text])),
  effective_from date NOT NULL,
  effective_to date,
  rule_payload jsonb NOT NULL,
  active boolean DEFAULT true,
  CONSTRAINT compliance_rules_pkey PRIMARY KEY (id)
);
CREATE TABLE public.conversation_analysis (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_log_id uuid,
  overall_tone text,
  response_quality text,
  misbehavior_detected boolean DEFAULT false,
  red_flags ARRAY,
  sentiment_score numeric,
  recommendation text,
  created_at timestamp with time zone DEFAULT now(),
  communication_effectiveness numeric,
  empathy_level numeric,
  problem_resolution text CHECK (problem_resolution = ANY (ARRAY['resolved'::text, 'partially_resolved'::text, 'unresolved'::text, 'escalated'::text])),
  customer_satisfaction_indicator numeric,
  key_issues ARRAY,
  positive_aspects ARRAY,
  improvement_areas ARRAY,
  urgency_level text CHECK (urgency_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  follow_up_required boolean DEFAULT false,
  compliance_score numeric,
  CONSTRAINT conversation_analysis_pkey PRIMARY KEY (id),
  CONSTRAINT conversation_analysis_conversation_log_id_fkey FOREIGN KEY (conversation_log_id) REFERENCES public.conversation_logs(id)
);
CREATE TABLE public.conversation_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid,
  customer_identifier text,
  audio_file_url text,
  transcribed_text text,
  ai_summary text,
  duration integer,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'transcribed'::text, 'analyzed'::text, 'error'::text])),
  error_message text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT conversation_logs_pkey PRIMARY KEY (id),
  CONSTRAINT conversation_logs_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.users(id)
);
CREATE TABLE public.device_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  fcm_token text NOT NULL UNIQUE,
  platform text NOT NULL CHECK (platform = ANY (ARRAY['android'::text, 'ios'::text, 'web'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  device_info jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  last_used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT device_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT device_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.employee_compensation (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  effective_from date NOT NULL,
  effective_to date,
  ctc_annual numeric NOT NULL CHECK (ctc_annual > 0::numeric),
  pay_schedule text NOT NULL DEFAULT 'monthly'::text,
  currency text NOT NULL DEFAULT 'INR'::text,
  compensation_payload jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  employee_name text,
  organization_id uuid,
  CONSTRAINT employee_compensation_pkey PRIMARY KEY (id),
  CONSTRAINT employee_compensation_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT employee_compensation_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.employee_hr_data (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  period_start date NOT NULL,
  period_end date NOT NULL,
  leaves integer DEFAULT 0,
  uninformed_absences integer DEFAULT 0,
  late_logins integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT employee_hr_data_pkey PRIMARY KEY (id),
  CONSTRAINT employee_hr_data_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.employee_pay_overrides (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  period_month integer NOT NULL CHECK (period_month >= 1 AND period_month <= 12),
  period_year integer NOT NULL,
  override_payload jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  source text NOT NULL DEFAULT ('manual'::text)::manual_ai_source,
  reason_code text,
  explainability jsonb,
  CONSTRAINT employee_pay_overrides_pkey PRIMARY KEY (id),
  CONSTRAINT employee_pay_overrides_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.employee_shifts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  shift_id uuid,
  effective_from date NOT NULL,
  effective_to date,
  assigned_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT employee_shifts_pkey PRIMARY KEY (id),
  CONSTRAINT employee_shifts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT employee_shifts_shift_id_fkey FOREIGN KEY (shift_id) REFERENCES public.shifts(id),
  CONSTRAINT employee_shifts_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.users(id)
);
CREATE TABLE public.notification_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['task_due'::text, 'task_assigned'::text, 'task_updated'::text, 'task_completed'::text, 'task_comment'::text, 'task_urgent'::text, 'task_overdue'::text, 'leave_request_new'::text, 'leave_request_approved'::text, 'leave_request_rejected'::text])),
  enabled boolean DEFAULT true,
  advance_notice interval DEFAULT '1 day'::interval,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notification_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT notification_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  task_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['task_due'::text, 'task_assigned'::text, 'task_updated'::text, 'task_completed'::text, 'task_comment'::text, 'task_urgent'::text, 'task_overdue'::text, 'leave_request_new'::text, 'leave_request_approved'::text, 'leave_request_rejected'::text])),
  title text NOT NULL,
  message text NOT NULL,
  read boolean DEFAULT false,
  scheduled_for timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  whatsapp_number text,
  ai_generated_message text,
  whatsapp_sent boolean DEFAULT false,
  whatsapp_sent_at timestamp with time zone,
  processing_status text DEFAULT 'pending'::text,
  org_whatsapp_enabled boolean,
  org_auto_alerts_enabled boolean,
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.org_statutory_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL UNIQUE,
  pf_number text,
  esic_number text,
  pt_state text,
  tan text,
  pan text,
  bank_details jsonb,
  challan_prefs jsonb,
  pt_reg_no text,
  CONSTRAINT org_statutory_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT org_statutory_profiles_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.organization_documents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  uploaded_by uuid NOT NULL,
  file_name text NOT NULL,
  original_file_name text NOT NULL,
  file_path text NOT NULL,
  file_url text NOT NULL,
  file_size bigint NOT NULL,
  mime_type text NOT NULL,
  category text DEFAULT 'general'::text,
  description text,
  tags ARRAY DEFAULT '{}'::text[],
  is_public boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  deleted_at timestamp with time zone,
  CONSTRAINT organization_documents_pkey PRIMARY KEY (id),
  CONSTRAINT organization_documents_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT organization_documents_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(id)
);
CREATE TABLE public.organization_invites (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  email text NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['user'::text, 'admin'::text])),
  token text NOT NULL UNIQUE,
  expires_at timestamp with time zone NOT NULL DEFAULT (now() + '7 days'::interval),
  invited_by uuid NOT NULL,
  accepted_at timestamp with time zone,
  revoked_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT organization_invites_pkey PRIMARY KEY (id),
  CONSTRAINT organization_invites_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT organization_invites_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.users(id)
);
CREATE TABLE public.organization_memberships (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['owner'::text, 'admin'::text, 'user'::text, 'viewer'::text])),
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'invited'::text, 'suspended'::text])),
  joined_at timestamp with time zone DEFAULT now(),
  invited_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT organization_memberships_pkey PRIMARY KEY (id),
  CONSTRAINT organization_memberships_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT organization_memberships_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.users(id),
  CONSTRAINT organization_memberships_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.organizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  advisory_types ARRAY DEFAULT ARRAY['Medication'::text, 'Diet'::text, 'Lifestyle'::text, 'Emergency'::text],
  round_types ARRAY DEFAULT ARRAY['Morning Round'::text, 'Evening Round'::text, 'Emergency Round'::text],
  follow_up_types ARRAY DEFAULT ARRAY['Post Surgery'::text, 'Treatment Progress'::text, 'Test Results'::text, 'General Check-up'::text],
  departments ARRAY DEFAULT ARRAY['Management'::text, 'Medical'::text, 'Nursing'::text],
  max_users integer DEFAULT 10,
  current_users integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  whatsapp_enabled boolean DEFAULT false,
  auto_alerts_enabled boolean DEFAULT false,
  whatsapp_api_endpoint text DEFAULT 'http://134.209.145.186:3001/api/send-message'::text,
  whatsapp_settings jsonb DEFAULT '{"rate_limit": 30, "priority_low": false, "priority_high": true, "priority_medium": true}'::jsonb,
  slug text,
  owner_user_id uuid,
  subscription_status text DEFAULT 'trial'::text CHECK (subscription_status = ANY (ARRAY['trial'::text, 'active'::text, 'past_due'::text, 'canceled'::text])),
  trial_ends_at timestamp with time zone DEFAULT (now() + '14 days'::interval),
  billing_email text,
  phone text,
  address text,
  location_latitude numeric CHECK (location_latitude IS NULL OR location_latitude >= '-90'::integer::numeric AND location_latitude <= 90::numeric),
  location_longitude numeric CHECK (location_longitude IS NULL OR location_longitude >= '-180'::integer::numeric AND location_longitude <= 180::numeric),
  location_address text,
  geofence_settings jsonb DEFAULT '{"enabled": true, "enforcement_mode": "strict", "allow_admin_override": true, "distance_threshold_meters": 500}'::jsonb,
  CONSTRAINT organizations_pkey PRIMARY KEY (id),
  CONSTRAINT organizations_owner_user_id_fkey FOREIGN KEY (owner_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.pay_components (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  name text NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['earning'::text, 'deduction'::text, 'employer_cost'::text])),
  calc_method text NOT NULL CHECK (calc_method = ANY (ARRAY['fixed'::text, 'percent_of_component'::text, 'percent_of_gross'::text, 'formula'::text])),
  calc_value numeric DEFAULT 0,
  taxable boolean DEFAULT true,
  pf_wage_participates boolean DEFAULT false,
  esic_wage_participates boolean DEFAULT false,
  sort_order integer DEFAULT 100,
  active boolean DEFAULT true,
  CONSTRAINT pay_components_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payroll_periods (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  month numeric NOT NULL CHECK (month >= 1::numeric AND month <= 12::numeric),
  year numeric NOT NULL,
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'locked'::text, 'posted'::text, 'challan_generated'::text])),
  lock_at timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payroll_periods_pkey PRIMARY KEY (id),
  CONSTRAINT payroll_periods_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT payroll_periods_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.payroll_runs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  payroll_period_id uuid NOT NULL,
  user_id uuid NOT NULL,
  snapshot jsonb NOT NULL,
  gross_earnings numeric NOT NULL,
  total_deductions numeric NOT NULL,
  net_pay numeric NOT NULL,
  employer_cost numeric NOT NULL,
  pf_wages numeric,
  esic_wages numeric,
  pt_amount numeric,
  tds_amount numeric,
  attendance_summary jsonb,
  created_at timestamp with time zone DEFAULT now(),
  status text,
  pf_employee text,
  CONSTRAINT payroll_runs_pkey PRIMARY KEY (id),
  CONSTRAINT payroll_runs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT payroll_runs_payroll_period_id_fkey FOREIGN KEY (payroll_period_id) REFERENCES public.payroll_periods(id)
);
CREATE TABLE public.performance_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  generated_by_user_id uuid,
  period_start date NOT NULL,
  period_end date NOT NULL,
  report_type text NOT NULL CHECK (report_type = ANY (ARRAY['monthly'::text, '6monthly'::text, 'yearly'::text])),
  metrics jsonb NOT NULL,
  gemini_summary text,
  ai_rating integer,
  created_at timestamp with time zone DEFAULT now(),
  conversation_metrics jsonb,
  quality_metrics jsonb,
  collaboration_metrics jsonb,
  improvement_plan jsonb,
  strengths ARRAY,
  development_areas ARRAY,
  CONSTRAINT performance_reports_pkey PRIMARY KEY (id),
  CONSTRAINT performance_reports_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT performance_reports_generated_by_user_id_fkey FOREIGN KEY (generated_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.personal_tasks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  title text NOT NULL,
  description text NOT NULL,
  priority text NOT NULL CHECK (priority = ANY (ARRAY['critical'::text, 'moderate'::text, 'lessImportant'::text])),
  status text NOT NULL CHECK (status = ANY (ARRAY['new'::text, 'pending'::text, 'inProgress'::text, 'completed'::text, 'overdue'::text])),
  due_date timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  assignee_id uuid,
  CONSTRAINT personal_tasks_pkey PRIMARY KEY (id),
  CONSTRAINT personal_tasks_assignee_id_fkey FOREIGN KEY (assignee_id) REFERENCES public.users(id),
  CONSTRAINT personal_tasks_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.quality_control_entries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  task_id uuid,
  user_id uuid,
  entry_date timestamp with time zone NOT NULL,
  entry_description text NOT NULL,
  remark text DEFAULT ''::text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quality_control_entries_pkey PRIMARY KEY (id),
  CONSTRAINT quality_control_entries_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT quality_control_entries_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.recurring_task_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  created_by uuid,
  assigned_to uuid,
  title text NOT NULL,
  description text NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['quickAdvisory'::text, 'clinicalRound'::text, 'followUp'::text, 'personalTask'::text])),
  priority text NOT NULL CHECK (priority = ANY (ARRAY['critical'::text, 'moderate'::text, 'lessImportant'::text])),
  recurrence_frequency text NOT NULL CHECK (recurrence_frequency = ANY (ARRAY['daily'::text, 'weekly'::text, 'monthly'::text, 'quarterly'::text, '6monthly'::text, 'yearly'::text])),
  start_date timestamp with time zone NOT NULL,
  end_date timestamp with time zone,
  number_of_occurrences integer,
  completion_within_hours integer,
  completion_within_days integer,
  last_generated_date timestamp with time zone,
  is_active boolean DEFAULT true,
  patient_id text,
  location text,
  round_type text,
  follow_up_type text,
  advisory_type text,
  contact_number text,
  manual_whatsapp_number text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT recurring_task_templates_pkey PRIMARY KEY (id),
  CONSTRAINT recurring_task_templates_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT recurring_task_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT recurring_task_templates_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.users(id)
);
CREATE TABLE public.shifts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  name character varying NOT NULL,
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  duration_hours integer NOT NULL CHECK (duration_hours = ANY (ARRAY[8, 9])),
  break_duration_minutes integer DEFAULT 60,
  late_threshold_minutes integer DEFAULT 15,
  early_out_threshold_minutes integer DEFAULT 15,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_overnight boolean DEFAULT false,
  buffer_minutes integer NOT NULL DEFAULT 0,
  CONSTRAINT shifts_pkey PRIMARY KEY (id),
  CONSTRAINT shifts_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.signup_trigger_debug (
  id bigint NOT NULL DEFAULT nextval('signup_trigger_debug_id_seq'::regclass),
  auth_user uuid,
  phase text,
  detail text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT signup_trigger_debug_pkey PRIMARY KEY (id)
);
CREATE TABLE public.statutory_filings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  payroll_period_id uuid NOT NULL,
  filing_type text NOT NULL CHECK (filing_type = ANY (ARRAY['PF_ECR'::text, 'ESIC_RETURN'::text, 'PT'::text, 'TDS24Q'::text, 'CHALLAN_PF'::text, 'CHALLAN_ESIC'::text])),
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'generated'::text, 'filed'::text])),
  file_url text,
  payload jsonb,
  generated_at timestamp with time zone,
  generated_by uuid,
  CONSTRAINT statutory_filings_pkey PRIMARY KEY (id),
  CONSTRAINT statutory_filings_payroll_period_id_fkey FOREIGN KEY (payroll_period_id) REFERENCES public.payroll_periods(id),
  CONSTRAINT statutory_filings_generated_by_fkey FOREIGN KEY (generated_by) REFERENCES public.users(id)
);
CREATE TABLE public.task_activity_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  task_id uuid,
  user_id uuid,
  action_type text NOT NULL,
  action_details jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT task_activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT task_activity_logs_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT task_activity_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.task_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  task_id uuid,
  user_id uuid,
  message text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT task_messages_pkey PRIMARY KEY (id),
  CONSTRAINT task_messages_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT task_messages_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.tasks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  type text NOT NULL DEFAULT 'task'::text CHECK (type = ANY (ARRAY['quickAdvisory'::text, 'clinicalRound'::text, 'followUp'::text, 'personalTask'::text, 'regularTask'::text, 'patientTracking'::text, 'auditTask'::text])),
  title text NOT NULL,
  description text NOT NULL,
  patient_id text,
  priority text NOT NULL DEFAULT 'low'::text CHECK (priority = ANY (ARRAY['critical'::text, 'moderate'::text, 'lessImportant'::text])),
  status text NOT NULL DEFAULT 'Pending'::text,
  created_by uuid,
  assigned_to uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  due_date timestamp with time zone,
  completed_at timestamp with time zone,
  location text,
  round_type text,
  follow_up_type text,
  advisory_type text,
  contact_number text,
  manual_whatsapp_number text,
  hours_to_complete integer,
  overdue_alert_count integer DEFAULT 0,
  last_overdue_alert_at timestamp with time zone,
  CONSTRAINT tasks_pkey PRIMARY KEY (id),
  CONSTRAINT tasks_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.users(id),
  CONSTRAINT tasks_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  auth_id uuid UNIQUE,
  organization_id uuid,
  name text NOT NULL,
  whatsapp_number text NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['superadmin'::text, 'admin'::text, 'user'::text])),
  department text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  email text NOT NULL UNIQUE,
  onboarding_state text DEFAULT 'new'::text CHECK (onboarding_state = ANY (ARRAY['new'::text, 'invited'::text, 'completed'::text])),
  invited_by uuid,
  last_active_at timestamp with time zone,
  is_active boolean DEFAULT true,
  phone text,
  full_name text,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_auth_id_fkey FOREIGN KEY (auth_id) REFERENCES auth.users(id),
  CONSTRAINT users_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);